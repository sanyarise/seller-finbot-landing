name: Deploy Landing

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate HTML
        run: |
          if [ ! -f index.html ]; then
            echo "ERROR: index.html not found"
            exit 1
          fi
          if [ ! -s index.html ]; then
            echo "ERROR: index.html is empty"
            exit 1
          fi
          echo "index.html OK, size: $(wc -c < index.html) bytes"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            index.html favicon.svg \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Verify deployment
        run: |
          sleep 5
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://seller-finbot.ru || echo "000")
          if [ "$RESPONSE" != "200" ]; then
            echo "WARNING: Site returned HTTP $RESPONSE (nginx may not be configured yet)"
          else
            echo "Deployment verified: HTTP $RESPONSE"
          fi
